<?php

/**
 * @Description: 首页模型
 */
class HomeModel extends MY_Model
{

    public function __construct()
    {
        parent::__construct();
    }

    /**
     * @function getData 各表新增数据汇总
     * @return   array $data   结果集
     */
    public function getData()
    {
    	$data = ['buyer'=>0, 'seller'=>0, 'order'=>0, 'goods'=>0];

    	// 新增买家
    	$this->db->select('count(*) as buyer');
        $this->db->from('user');
        $today = strtotime(date('Y-m-d'));
        $this->db->where('create_time >= ', $today);
        $tmp = $this->db->get()->row_array();

        $data['buyer'] = $tmp['buyer'];
        $this->db->reset_query();

        // 新增卖家
    	$this->db->select('count(*) as seller');
        $this->db->from('user_shop');
        $this->db->where('create_time >= ', $today);
        $tmp = $this->db->get()->row_array();
        $data['seller'] = $tmp['seller'];
        $this->db->reset_query();

        // 新增订单
    	$this->db->select('count(*) as orders');
        $this->db->from('order');
        $this->db->where('create_time >= ', $today);
        $tmp = $this->db->get()->row_array();
        $data['order'] = $tmp['orders'];
        $this->db->reset_query();

        // 新增商品
        $this->db->select('count(*) as goods');
        $this->db->from('goods');
        $this->db->where('add_time >= ', $today);
        $tmp = $this->db->get()->row_array();
        $data['goods'] = $tmp['goods'];
        $this->db->reset_query();
        return $data;
    }
    public function getSeller()
    {
        //卖家top5数据
        $this->db->select('sum(shop_order.money) as mon,user_shop.shop,user_shop.address_id',FALSE);
        $this->db->from('order');
        $today = strtotime(date('Y-m-d'));
        $this->db->where('order.create_time <= ',$today);

        //查出卖家店铺的相关信息
        $this->db->join('user_shop','user_shop.uid = order.sellers_id','left');

        $this->db->group_by('order.sellers_id');
        //计算订单总金额前5的卖家
        $this->db->order_by('mon','desc')->limit(5);
        $res = $this->db->get()->result_array();
        return $res;
    }

    public function getBuyer()
    {
        //买家top5数据
        $this->db->select('sum(shop_order.money) as mon,user.username,user.districtId',FALSE);
        $this->db->from('order');
        $today = strtotime(date('Y-m-d'));
        $this->db->where('order.create_time <= ',$today);

        //查出买家的相关信息
        $this->db->join('user','user.id = order.buyer_id','left');

        $this->db->group_by('order.buyer_id');
        //计算订单消费总金额前5的买家
        $this->db->order_by('mon','desc')->limit(5);
        $res = $this->db->get()->result_array();
        return $res;
    }

    public function getGoods ()
    {
        //商品销量top5数据
        $this->db->select('sum(shop_goods.amount) as total,sum(shop_order_goods.money) as mon',FALSE);
        $this->db->from('goods');

        //查出有该商品订单的相关信息
        $this->db->join('order_goods','order_goods.gid = goods.id','left');

        $this->db->group_by('order_goods.gid');
        //计算商品销量前5的商品，销售金额
        $this->db->order_by('mon','desc')->limit(5);
        $res = $this->db->get()->result_array();
        return $res;
    }
    public function showLine ()
    {
        $res = Array
        (
            'days' => Array
            (
                0 => '01-24',
                1 => '01-25',
                2 => '01-26',

            ),

        'shop' => Array
            (
                0 => 100,
                1 => 200,
                2 => 300,
            ),

        'district' => Array
            (
                0 => 500,
                1 => 1000,
                2 => 600,

            ) ,

        'type' => Array
            (
                0 => 1,
                1 => 2,
                2 => 3,
            ),

        'money' => Array
            (
                0 => 500,
                1 => 900,
                2 => 820

            )

    );
        return $res;
    }

    public function showTips ()
    {
        //查询用户反馈表
        $this->db->select('feedback.body,feedback.time,user.username ',FALSE);
        $this->db->from('feedback');
        $this->db->join('user','user.id = feedback.uid ','left');
        $today = strtotime(date('Y-m-d'));
        //$this->db->where('order.time >= ',$today);
        $this->db->order_by('time','desc')->limit(2);
        $data['list'] = $this->db->get()->result_array();
        foreach($data['list'] as $key=>$val){
            $data['list'][$key]['time'] = date('Y年m月d日 H:i:s',$val['time']);
        }
        return $data;
    }

    public function cashApply ()
    {
       //查询用户余额表
        $this->db->select('user_money.id,user_money.uid,user_money.create_time,user_money.money,user.username',FALSE);
        $this->db->from('user_money');
        $this->db->join('user','user.id = user_money.uid','left');
        $today = strtotime(date('Y-m-d'));
        //$this->db->where('user_money.create_time >=',$today);
        $this->db->order_by('create_time','desc')->limit(2);

        //审核状态为1
        $this->db->where('user_money.status = ',1);
        $data['list'] = $this->db->get()->result_array();
        foreach($data['list'] as $key=>$val){
            $data['list'][$key]['create_time'] = date('Y年m月d日 H:i:s',$val['create_time']);
        }
        return $data;
    }

}
