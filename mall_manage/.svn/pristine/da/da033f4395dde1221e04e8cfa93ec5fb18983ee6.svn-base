<?php

class BuyerModel extends MY_Model
{

    public function __construct()
    {
        parent::__construct();
    }
    /**
     * @DateTime  2017-12-19
     * @copyright 买家列表
     * @return    [type]      [description]
     */
    public function buyerList( $status,$username,$page ){
        $this->db->select('*');
        $this->db->from('user');
        if(!empty($username)){
            $this->db->like( 'username', $username );
        }
        if($status >= 0){
            $this->db->where( 'status', $status );
        }
        $this->db->where( 'id > ', '10' );
        $total_rows = $this->db->count_all_results('', false);

        $pager = $this->setPager($total_rows, $page);
        $this->db->limit($pager['per_page'], $pager['start_page']);
        $this->db->order_by('id', 'DESC');

        $res['list'] = $this->db->get()->result_array();
        $res['pager_links'] = $this->pagination->create_links();
        return $res;
    }
    /**
     * @DateTime  2017-12-20
     * @copyright 买家禁言与解禁
     * @param     [type]      $id     [description]
     * @param     [type]      $status [description]
     * @return    [type]              [description]
     */
    public function buyerLock( $id, $status ){
        $status = ($status == '0') ? '2' : '0';
        $res = $this->db->update('user',array( 'status'=>$status ),array( 'id'=>$id ));
        if($res){
            return true;
        }
    }

    /**
     * @DateTime  2017-12-20
     * @copyright 买家详情
     * @param     [type]      $id [description]
     * @return    [type]          [description]
     */
    public function buyerDetail( $id )
    {
        $res = $this->db->get_where( 'user', array('id'=>$id) )->row_array();
        return $res;
    }

    /**
     * @DateTime  2018-3-2
     * @copyright 买家顶部统计
     * @param     [type]      $id [description]
     * @return    [type]          [description]
     */

    public function countBuyer()
    {
        //新增买家
        $this->db->select('count(id) as num');
        $this->db->from('user');
        //买家
        $this->db->where('is_sellers = ',0);
        $today = strtotime(date('Y-m-d'));

        $this->db->where('create_time >=',$today);
        $tmp = $this->db->get()->row_array();
        $data['new_buyers'] = $tmp['num'];

        //买家总数
        $this->db->select('count(id) as total');
        $this->db->from('user');

        $this->db->where('is_sellers = ',0);

        $tmp = $this->db->get()->row_array();
        $data['total_buyers'] = $tmp['total'];
        return $data;
    }

    /**
     * @DateTime  2018-3-2
     * @copyright 买家列表
     * @param     [type]      $id [description]
     * @return    [type]          [description]
     */

    public function getBuyerList()
    {
        $this->db->select('a.username,a.districtId,a.gender,a.create_time,a.phone,b.name,b.status');
        $this->db->from('user a');
        $this->db->join('user_money b','b.uid = a.id','left');
        //买家
        $this->db->where('is_sellers = ',0);

        //计算总记录条数
        $total_rows = $this->db->count_all_results('',false);

        // 翻页设置
        $per_page   = isset($this->data['base']['per_page']) ? $this->data['base']['per_page'] : $this->data['common']['per_page'];
        $uri_segment = isset($this->data['base']['uri_segment']) ? $this->data['base']['uri_segment'] : $this->data['common']['uri_segment'];

        $curpage     = $this->uri->segment($uri_segment) ? $this->uri->segment($uri_segment) : 1;

        $start_page  = ($curpage && is_numeric($curpage) && $curpage > 1) ? ($curpage - 1) * $per_page : 0;

        $this->db->limit($per_page, $start_page);

        $data['list'] = $this->db->get()->result_array();

        // 启始页
        $data['start_page'] = $start_page;
        // 总条数
        $data['total_rows'] = $total_rows;
        // 每页多少条
        $data['per_page'] = $per_page;
        // 当前页
        $data['curpage'] = $curpage;
        // 当前页查询结果总条数
        $data['list_count'] = count($data['list']);
        // 总页数，有小数进1
        $data['pages'] = ceil($total_rows / $per_page);

        return $data;
    }
    /**
     * @DateTime  2018-3-2
     * @copyright 买家消费金额统计
     * @param     [type]      $id [description]
     * @return    [type]          [description]
     */
    public function getBuyerCost()
    {
        $this->db->select('sum(a.money) mon,b.username');
        $this->db->from('order a');
        $this->db->join('user b','b.id = a.buyer_id','left');
        $this->db->group_by('a.buyer_id');
        $this->db->order_by('mon','DESC');
        $this->db->limit(10);
        $res = $this->db->get()->result_array();
        $res['mons'] = array_column($res,'mon');
        $res['names'] = array_column($res,'username');
        return $res;
    }

    public function getBuyerUsers()
    {
        $this->db->select('sum(a.money) mon,b.username');
        $this->db->from('order a');
        $this->db->join('user b','b.id = a.buyer_id','left');
        $this->db->group_by('a.buyer_id');
        $this->db->order_by('mon','DESC');
        $this->db->limit(10);
        $res = $this->db->get()->result_array();
        $res['mons'] = array_column($res,'mon');
        $res['names'] = array_column($res,'username');
        return $res;
    }
}
