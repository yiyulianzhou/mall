<?php

/**
 * 财富管理
 */
class MoneyModel extends MY_Model
{

    public function __construct()
    {
        parent::__construct();
    }
    /**
     * @copyright 卖家提现
     * @param     [type]      $username [description]
     * @param     [type]      $page     [description]
     * @return    [type]                [description]
     */
    public function sellerCash( $username,$page,$state )
    {
    	$this->db->select('a.*,b.username,b.avatarUrl,c.realname,d.realname as payName');
    	$this->db->from('user_money a');
    	$this->db->join('user b','b.id=a.uid','left');
    	$this->db->join('admin c','c.id=a.verify_user','left');
    	$this->db->join('admin d','d.id=a.pay_user','left');
    	$this->db->where('b.is_sellers','1');
    	if(!empty($username)){
    		$this->db->like('b.username',$username);
    	}
    	if($state > -1){
    		$this->db->where('a.status',$state);
    	}
    	$this->db->where('a.user_type','2');
    	$this->db->where('a.type','1');
    	$total_rows = $this->db->count_all_results('', false);
        $pager = $this->setPager($total_rows, $page);
        $this->db->limit($pager['per_page'], $pager['start_page']);
        $this->db->order_by('id', 'DESC');
        $res['list'] = $this->db->get()->result_array();
        $res['pager_links'] = $this->pagination->create_links();
        return $res;
    }
    /**
     * @copyright 买家提现
     * @param     [type]      $username [description]
     * @param     [type]      $page     [description]
     * @return    [type]                [description]
     */
    public function buyerCash( $username,$page,$state )
    {
    	$this->db->select('a.*,b.username,b.avatarUrl,c.realname,d.realname as payName');
    	$this->db->from('user_money a');
    	$this->db->join('user b','b.id=a.uid','left');
    	$this->db->join('admin c','c.id=a.verify_user','left');
    	$this->db->join('admin d','d.id=a.pay_user','left');
    	$this->db->join('user_account e','e.id=a.account_id','left');
    	if(!empty($username)){
    		$this->db->like('b.username',$username);
    	}
    	if($state > -1){
    		$this->db->where('a.status',$state);
    	}
    	$this->db->where('a.user_type','1');
    	$this->db->where('a.type','1');
    	$total_rows = $this->db->count_all_results('', false);
        $pager = $this->setPager($total_rows, $page);
        $this->db->limit($pager['per_page'], $pager['start_page']);
        $this->db->order_by('id', 'DESC');
        $res['list'] = $this->db->get()->result_array();
        $res['pager_links'] = $this->pagination->create_links();
        return $res;
    }
    /**
     * @copyright 提现审核
     * @param     [type]      $id [description]
     * @return    [type]          [description]
     */
    public function verify( $id, $status, $verify )
    {
    	if( $verify == 'verify' ){
    		if( $status == 1 ){
    			return true;
    		}
            //审核不通过
            if($status == 3){
                $data['verify_user'] = $this->user_session['uid'];
                $data['verify_time'] = time();
                $data['status'] = $status;
                $this->db->select('money,uid');
                $this->db->from('user_money');
                $this->db->where('id',$id);
                $userMoney = $this->db->get()->row_array();
                $money=$userMoney['money'];
                $uid=$userMoney['uid'];
                $this->db->trans_begin();
                $sql = " update shop_user set money=money+$money where id = $uid  ";
                $update = $this->db->query($sql);
                $res = $this->db->update('user_money',$data,array('id'=>$id));
                if ($this->db->trans_status() === FALSE)
                {
                    $this->db->trans_rollback();
                }
                else
                {
                    $this->db->trans_commit();
                    return true;
                }

            }
    		$data['verify_user'] = $this->user_session['uid'];
    		$data['verify_time'] = time();
    		$data['status'] = $status;
    	}else{
    		if( $status == 12 ){
    			return true;
    		}
    		$data['pay_user'] = $this->user_session['uid'];
    		$data['pay_time'] = time();
    		$data['status'] = $status;
    	}
    	$res = $this->db->update('user_money',$data,array('id'=>$id));
    	if($res){
    		return true;
    	}
    }
    /**
     * @copyright 充值列表
     * @param     [type]      $username [description]
     * @param     [type]      $page     [description]
     * @return    [type]                [description]
     */
    public function recharge( $username,$page )
    {
    	$this->db->select('a.*,b.username,b.avatarUrl');
    	$this->db->from('user_money a');
    	$this->db->join('user b','b.id=a.uid','left');
    	if(!empty($username)){
    		$this->db->like('b.username',$username);
    	}
    	$this->db->where('a.type','2');
    	$total_rows = $this->db->count_all_results('', false);
        $pager = $this->setPager($total_rows, $page);
        $this->db->limit($pager['per_page'], $pager['start_page']);
        $this->db->order_by('id', 'DESC');
        $res['list'] = $this->db->get()->result_array();
        $res['pager_links'] = $this->pagination->create_links();
        return $res;
    }
    /**
     * @copyright 详情
     * @param     [type]      $id [description]
     * @return    [type]          [description]
     */
    public function detail($id)
    {
    	$this->db->select('a.*,b.username,b.avatarUrl,c.realname,d.realname as payName,e.type as accountType,e.account');
    	$this->db->from('user_money a');
    	$this->db->join('user b','b.id=a.uid','left');
    	$this->db->join('admin c','c.id=a.verify_user','left');
    	$this->db->join('admin d','d.id=a.pay_user','left');
    	$this->db->join('user_account e','e.id=a.account_id','left');
    	$this->db->where('a.id',$id);
    	$res = $this->db->get()->row_array();
    	return $res;
    }
}
